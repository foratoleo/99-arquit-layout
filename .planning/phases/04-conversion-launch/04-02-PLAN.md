---
phase: 04-conversion-launch
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.js
  - public/images/*
  - src/app/layout.tsx
  - src/lib/performance.ts
autonomous: true

must_haves:
  truths:
    - LCP < 2.5s on mobile and desktop
    - CLS < 0.1 on mobile and desktop
    - PageSpeed score >= 90 on both mobile and desktop
    - All images use next/image with explicit dimensions
    - Hero images use priority prop
  artifacts:
    - path: "next.config.js"
      provides: "Image optimization configuration with formats and quality"
      contains: "images|formats|deviceSizes"
    - path: "src/lib/performance.ts"
      provides: "Performance monitoring utilities and validation"
      exports: ["checkCoreWebVitals", "optimizeImages"]
    - path: "src/app/layout.tsx"
      provides: "Font optimization with next/font, meta tags for SEO"
      contains: "next/font|metadata"
  key_links:
    - from: "next.config.js"
      to: "Next.js Image Optimization"
      via: "image loader configuration"
      pattern: "loader|formats"
    - from: "src/app/layout.tsx"
      to: "Google Fonts"
      via: "next/font local/sub optimization"
      pattern: "next/font"
    - from: "All image components"
      to: "WebP/AVIF formats"
      via: "next/image automatic format conversion"
      pattern: "next/image"
---

<objective>
Validate performance targets (LCP < 2.5s, CLS < 0.1, PageSpeed >= 90) and optimize image loading strategy.

Purpose: Performance is a requirement, not an enhancement. Luxury aesthetic doesn't excuse slow loading. Research shows users abandon sites that take >3s to load. Image optimization is critical for architecture sites with heavy photography.

Output: Optimized build configuration, performance validation utilities, all images using next/image with proper lazy loading.
</objective>

<execution_context>
@/Users/forato/.claude/get-shit-done/workflows/execute-plan.md
@/Users/forato/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/SUMMARY.md
@.planning/research/PITFALLS.md

# Research highlights
- CLS from lazy-loading above-fold content is PITFALL #1
- Hero image killing LCP is PITFALL #3
- Always use next/image with explicit width/height
- Use priority prop on hero/LCP images
- Test on real devices, not just dev tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js image optimization</name>
  <files>next.config.js</files>
  <action>
    Update next.config.js with image optimization:
    - Enable AVIF and WebP formats (formats: ['image/avif', 'image/webp'])
    - Set device sizes for responsive images: [640, 750, 828, 1080, 1200, 1920, 2048, 3840]
    - Set image sizes for srcset: [16, 32, 48, 64, 96, 128, 256, 384]
    - Quality: 85 (balance between visual quality and file size)
    - Enable sharp image processor (if available) for faster optimization
    - Minimum cache TTL: 60 seconds for optimized images

    Configuration must avoid PITFALL #1 (CLS from lazy loading): all images must have explicit dimensions in components.
  </action>
  <verify>next.config.js exists with images configuration including formats and quality settings</verify>
  <done>Image optimization configured for AVIF/WebP with responsive sizes</done>
</task>

<task type="auto">
  <name>Task 2: Create performance validation utilities</name>
  <files>src/lib/performance.ts</files>
  <action>
    Create src/lib/performance.ts with:
    - checkCoreWebVitals() function that uses PerformanceObserver API to measure LCP, CLS, FID in browser
    - Image audit function that scans DOM for images without explicit dimensions
    - Lighthouse score threshold validation (target: 90+)
    - Export performance config object with targets: {lcp: 2500, cls: 0.1, pagespeed: 90}
    - Console logging during development to surface metrics
    - Function to generate performance report for documentation

    Include warnings for:
    - Images without width/height props
    - Images above fold without priority prop
    - Fonts loading late (FOUT/FOIT detection)
  </action>
  <verify>performance.ts exports checkCoreWebVitals, has target thresholds defined</verify>
  <done>Performance utilities created with Core Web Vitals monitoring</done>
</task>

<task type="auto">
  <name>Task 3: Audit and fix all image usage</name>
  <files>src/components/**/*.tsx, src/app/**/*.tsx</files>
  <action>
    Scan all components and pages for image usage:
    - Replace all HTML <img> tags with next/image
    - Add explicit width and height props to every Image component (PITFALL #1 prevention)
    - Add priority prop to hero/LCP images (PITFALL #3 prevention)
    - Add loading="eager" to above-fold images
    - Keep loading="lazy" default for below-fold images
    - Add placeholder="blur" with data URLs for better UX (optional, generates blur placeholders)
    - Ensure all images are in public/images directory or imported from assets

    Run: grep -r "<img" src/ to find any remaining HTML img tags
    Run: grep -r "from 'next/image'" src/ to verify next/image imports

    For placeholder images (CNT-02 addressed in 04-03), use Unsplash source with architecture keywords.
  </action>
  <verify>
    No HTML <img> tags remain, all images use next/image with explicit dimensions, hero images have priority prop
  </verify>
  <done>All images optimized with next/image, explicit dimensions, proper lazy loading</done>
</task>

<task type="auto">
  <name>Task 4: Optimize font loading with next/font</name>
  <files>src/app/layout.tsx</files>
  <action>
    Update src/app/layout.tsx to use next/font:
    - Import font from next/font/google (Playfair Display for headings, Inter for body)
    - Use display: 'swap' to prevent FOUT, but configure preload for better performance
    - Add font subsets: 'latin' for PT-BR content
    - Configure font-weight variable for optimal loading
    - Apply fonts via CSS variable in layout
    - Add preconnect links to Google Fonts in head for faster connection

    Example:
    import { Playfair_Display, Inter } from 'next/font/google'
    const playfair = Playfair_Display({ subsets: ['latin'], display: 'swap', variable: '--font-heading' })
    const inter = Inter({ subsets: ['latin'], display: 'swap', variable: '--font-body' })

    This prevents PITFALL #2 (font loading causing layout shift).
  </action>
  <verify>layout.tsx uses next/font for all typography, fonts configured with display: 'swap'</verify>
  <done>Fonts optimized with next/font, no layout shift from font loading</done>
</task>

<task type="auto">
  <name>Task 5: Run Lighthouse audit and fix issues</name>
  <files>various (based on audit results)</files>
  <action>
    Run Lighthouse audit in Chrome DevTools:
    1. Open npm run dev server
    2. Open Chrome DevTools > Lighthouse
    3. Run audit for both Mobile and Desktop
    4. Check scores: Performance, Accessibility, Best Practices, SEO
    5. Target: Performance >= 90, Accessibility >= 90, Best Practices >= 90, SEO >= 90

    For Performance scores < 90, investigate:
    - LCP > 2.5s: Check hero image priority, image compression, JS bundle size
    - CLS > 0.1: Find images without dimensions, dynamic content injection
    - FID/INP > 100ms: Reduce main thread work, split long tasks

    Common fixes:
    - Remove unused CSS (Tailwind purging should handle this)
    - Defer non-critical JavaScript
    - Add rel="preload" for critical resources
    - Enable text compression (Vercel handles this automatically)

    Document results in performance report.
  </action>
  <verify>Lighthouse scores: Performance >= 90, LCP < 2.5s, CLS < 0.1 on both mobile and desktop</verify>
  <done>Performance targets achieved: LCP < 2.5s, CLS < 0.1, PageSpeed >= 90</done>
</task>

</tasks>

<verification>
- next.config.js has image optimization configured
- All images use next/image with explicit dimensions
- Hero images have priority prop
- Fonts use next/font for optimal loading
- Lighthouse scores meet targets
</verification>

<success_criteria>
- [ ] LCP < 2.5s on mobile and desktop
- [ ] CLS < 0.1 on mobile and desktop
- [ ] PageSpeed score >= 90 on both mobile and desktop
- [ ] All images use next/image with explicit dimensions
- [ ] Hero images use priority prop
</success_criteria>

<output>
After completion, create `.planning/phases/04-conversion-launch/04-02-SUMMARY.md`
</output>
